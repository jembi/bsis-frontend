<div class="col-sm-3 col-md-2" ng-include="'views/testing/sidebar.html'"></div>
<div class="col-sm-9 col-md-10 main">
  <span class="h3 page-header">Manage Test Batches</span>

  <hr/>

  <div class="col-sm-12">

      <uib-tabset justified="true">
          <uib-tab>
              <uib-tab-heading>
                  <i class="fa {{icons.BARS}}"></i> Open Batches
              </uib-tab-heading>
              <div ng-switch="openTestBatches" class="col-sm-12">
                  <div style="padding-bottom: 10px"></div>
                  <div class="panel panel-default">
                      <div class="panel-body">
                          <div ng-switch-when="true">


                              <table ng-table="testBatchTableParams" show-filter="false" class="table">
                                  <tr ng-repeat="testBatch in $data"
                                      ng-click="viewTestBatch(testBatch);"
                                      ng-mouseenter="this.$selected = true"
                                      ng-mouseleave="this.$selected = false"
                                      ng-class="{'active': testBatch.$selected}">
                                      <td data-title="'Created On'" style="width:30%;" header-class="text-left"
                                          class="text-center" sortable="'createdDate'">
                                          {{testBatch.createdDate | bsisDateTime}}
                                      </td>
                                      <td data-title="'Test Samples'" style="width:15%;" header-class="text-left"
                                          class="text-center" sortable="'numSamples'">
                                          {{testBatch.numSamples}}
                                      </td>
                                      <td data-title="'Status'" style="width:20%;" header-class="text-left"
                                          class="text-center" sortable="'status'">
                                          {{testBatch.status}}
                                      </td>
                                      <td data-title="'Location'" style="width:35%;" header-class="text-left"
                                          class="text-center" sortable="'location'">
                                          {{testBatch.location.name}}
                                      </td>
                                  </tr>
                              </table>

                          </div>


                          <div ng-switch-when="false">
                              <p>
                                  <em> No open test batches. </em>
                              </p>
                          </div>


                          <div has-permission="{{permissions.ADD_TEST_BATCH}}">
                              <h4>New Test Batch</h4>

                              <div ng-switch on="donationBatches.length">
                                  <div ng-switch-when="0">
                                      <p><em>There are no donation batches to test.</em></p>
                                  </div>
                                  <div ng-switch-default>
                                      <form name="addTestBatchForm" novalidate class="form-horizontal col-sm-12"
                                            role="form"
                                            ng-submit="addTestBatch(selectedDonationBatches.ids, addTestBatchForm.$valid)">
                                          <div class="form-group">
                                              <label for="name" class="col-sm-2 control-label">Donation Batches</label>
                                              <div class="row col-sm-10">
                                                  <div class="form-inline" style="padding-left:5px;">
                                                      <ui-select name="donationBatches" required multiple
                                                                 ng-model="selectedDonationBatches.ids" theme="bootstrap"
                                                                 ng-disabled="disabled" style="width: 700px;">
                                                          <ui-select-match placeholder="Select:">{{$item.venue.name}}
                                                              ({{$item.createdDate | bsisDate}})
                                                          </ui-select-match>
                                                          <ui-select-choices
                                                                  repeat="donationBatch.id as donationBatch in donationBatches | filter:$select.search">
                                                              <div ng-bind-html="donationBatch.venue.name"></div>
                                                              <small>
                                                                  {{donationBatch.createdDate | bsisDate}} |
                                                                  {{donationBatch.numDonations}} donations
                                                              </small>
                                                          </ui-select-choices>
                                                      </ui-select>
                                                      <div>
                                                          <small class="error"
                                                                 ng-show="(addTestBatchForm.donationBatches.$invalid && (addTestBatchForm.donationBatches.$dirty || submitted))">
                                                              Select one or more donation batches
                                                          </small>
                                                      </div>
                                                  </div>
                                              </div>
                                          </div>

                                          <div class="form-group">
                                              <div class="col-sm-offset-2 col-sm-4">
                                                  <button class="btn btn-primary" type="submit"
                                                          ng-disabled="addingTestBatch">{{addingTestBatch ? "Adding..." :
                                                      "Add Test Batch"}}
                                                  </button>
                                                  <button class="btn btn-primary" type="button"
                                                          ng-click="clearAddTestBatchForm(addTestBatchForm);">Clear
                                                  </button>
                                              </div>
                                          </div>

                                      </form>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

          </uib-tab>

          <uib-tab>
              <uib-tab-heading>
                  <i class="fa {{icons.ARCHIVE}}"></i> Closed Batches
              </uib-tab-heading>
              <form name="closedTestBatchesForm"  class="form-horizontal" style="padding:10px 0;" ng-submit="getClosedTestBatches(closedTestBatchesForm)">
                  <div class="clearfix form-group">
                      <label class="col-sm-2 control-label">Period:</label>
                      <div class="form-inline col-sm-10">
                          <div>
                              <dateselect name="startDate"  ng-model="search.startDate" format="dateFormat"  ng-class="{'has-error' : (closedTestBatchesForm.startDate.$invalid)}" ng-required="true" ui-date-range="1,months" ui-date-end="{{search.endDate | date:'yyyy-MM-dd HH:mm:ss'}}" ng-model-options="{ allowInvalid: true }"></dateselect>
                              <span><em>To:</em></span>
                              <dateselect-end name="endDate"  ng-model="search.endDate" format="dateFormat" ng-class="{'has-error' : (closedTestBatchesForm.endDate.$invalid)}" ng-required="true" ui-date-range="1,months" ui-date-start="{{search.startDate |  date:'yyyy-MM-dd HH:mm:ss'}}" ng-model-options="{ allowInvalid: true }"></dateselect-end>
                          </div>
                          <div>
                              <small class="error" ng-show="(closedTestBatchesForm.startDate.$error.required || closedTestBatchesForm.endDate.$error.required)">
                                  Select a valid date
                              </small>
                              <small class="error" ng-show="(closedTestBatchesForm.startDate.$error.uiDateRange || closedTestBatchesForm.endDate.$error.uiDateRange)">
                                  Select a date range that is less than one month
                              </small>
                          </div>
                      </div>
                  </div>
                  <div class="col-sm-offset-2 ">
                      <button class="btn btn-primary" type="submit" ng-disabled="searching">{{searching ? "Searching..." :
                          "Search"}}
                      </button>
                      <button class="btn btn-primary" type="reset" ng-click="clearClosedBatchesSearch()">Clear</button>
                  </div>
              </form>
              <div ng-switch="closedTestBatches" class="col-sm-12">
                  <div ng-switch-when="true">
                      <div style="padding-bottom: 10px"></div>
                      <div class="panel panel-default">
                          <div class="panel-body">

                              <table ng-table="closedTestBatchesTableParams" show-filter="false" class="table">
                                  <tr ng-repeat="testBatch in $data"
                                      ng-click="viewTestBatch(testBatch);"
                                      ng-mouseenter="this.$selected = true"
                                      ng-mouseleave="this.$selected = false"
                                      ng-class="{'active': testBatch.$selected}">
                                      <td data-title="'Created On'" style="width:20%;" header-class="text-left"
                                          class="text-center" sortable="'createdDate'">
                                          {{testBatch.createdDate | bsisDate}}
                                      </td>
                                      <td data-title="'Closed'" style="width:20%;" header-class="text-left"
                                          sortable="'date'">
                                          {{testBatch.lastUpdated | bsisDateTime}}
                                      </td>
                                      <td data-title="'Test Samples'" style="width:15%;" header-class="text-left"
                                          class="text-center" sortable="'numSamples'">
                                          {{testBatch.numSamples}}
                                      </td>
                                      <td data-title="'Status'" style="width:15%;" header-class="text-left"
                                          class="text-center" sortable="'status'">
                                          {{testBatch.status}}
                                      </td>
                                      <td data-title="'Location'" style="width:30%;" header-class="text-left"
                                          class="text-center" sortable="'location'">
                                          {{testBatch.location.name}}
                                      </td>
                                  </tr>
                              </table>

                          </div>
                      </div>
                  </div>
                  <div ng-switch-when="false">
                      <div class="panel panel-default" ng-if="closedTestBatchData">
                          <div class="panel-body">
                              <p>
                                  <em> No closed test batches. </em>
                              </p>
                          </div>
                      </div>
                  </div>
              </div>
          </uib-tab>


      </uib-tabset>
</div>
