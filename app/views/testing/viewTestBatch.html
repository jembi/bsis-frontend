<span class="h3 page-header">Manage Test Batch</span>

<span class="h4" style="float: right; margin-top: 5px; padding-right: 15px; display:inline;">
    <span has-permission="{{permissions.VOID_TEST_BATCH}}" ng-hide="confirmEdit">
      <em>
          <button class="btn btn-link" style="padding:0;" ng-click="confirmDelete = true" ng-hide="confirmDelete"
                  ng-disabled="!testBatch.permissions.canDelete">Void
          </button>
      </em>
      <span ng-show="confirmDelete">
        <em>
            <button class="btn btn-link text-danger" style="padding:0;"
                    ng-click="deleteTestBatch(testBatch.id); confirmDelete = false">Void
            </button>
            <button class="btn btn-link text-muted" style="padding:0;" ng-click="confirmDelete = false">Cancel</button>
        </em>
      </span>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-hide="confirmDelete">
      <span ng-hide="confirmEdit">
      | <em>
          <button class="btn btn-link" style="padding:0;" ng-click="editableForm.$show(); confirmEdit = true"
                  ng-disabled="!testBatch.permissions.canEdit">Edit
          </button>
      </em>
      </span>
      <span ng-show="confirmEdit">
        <em>
            <button class="btn btn-link text-muted" style="padding:0;" ng-disabled="editableForm.$waiting"
                    ng-click="editableForm.$submit(); confirmEdit = false">Save
            </button>
            <button class="btn btn-link text-muted" style="padding:0;" ng-disabled="editableForm.$waiting"
                    ng-click="editableForm.$cancel(); confirmEdit = false">Cancel
            </button>
        </em>
      </span>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-hide="confirmDelete || confirmEdit">
    | <em>
        <button class="btn btn-link" style="padding:0;" ng-disabled="!testBatch.permissions.canRelease"
                ng-click="releaseTestBatch(testBatch)">Release
        </button>
    </em>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-if="testBatch.status!='CLOSED'"
          ng-hide="confirmDelete || confirmEdit">
    | <em>
        <button class="btn btn-link" style="padding:0;" ng-disabled="!testBatch.permissions.canClose"
                ng-click="closeTestBatch(testBatch)">Close Batch
        </button>
    </em>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-if="testBatch.status=='CLOSED'"
          ng-hide="confirmDelete || confirmEdit">
    | <em>
        <button class="btn btn-link" style="padding:0;" ng-disabled="!testBatch.permissions.canReopen"
                ng-click="reopenTestBatch(testBatch)">Reopen Batch
        </button>
    </em>
    </span>
  </span>

<span ng-if="testBatch.status!='CLOSED'" class="h4" style="float: right; margin-top: 5px; ">
    <span has-permission="{{permissions.ADD_TTI_OUTCOME}}" ng-hide="confirmDelete || confirmEdit">
      <em>
          <button class="btn btn-link" style="padding:0;" ng-click="recordTestResults(testBatch, 'tti')">Record TTI Test
              Results
          </button>
      </em>
    </span>
    <span has-permissions="{{permissions.ADD_TTI_OUTCOME}};{{permissions.ADD_BLOOD_TYPING_OUTCOME}}"
          ng-hide="confirmDelete || confirmEdit"> | </span>
    <span has-permission="{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" ng-hide="confirmDelete || confirmEdit">
      <em>
          <button class="btn btn-link" style="padding:0;" ng-click="recordTestResults(testBatch, 'bloodGrouping')">
              Record Blood Group Serology Results
          </button>
      </em>
    </span>
    <span has-permissions="{{permissions.ADD_TTI_OUTCOME}};{{permissions.ADD_BLOOD_TYPING_OUTCOME}};{{permissions.VOID_TEST_BATCH}}"
          ng-hide="confirmDelete || confirmEdit"> | </span>
  </span>

<hr style="clear:right;"/>

<span class="h4" style="float: right; margin-top: 0px; margin-bottom: 0px; padding-right: 15px;">
  <span has-permissions="{{permissions.ADD_TTI_OUTCOME}}" ng-hide="testBatch.status=='CLOSED'"> <small><em><a href=""
                                                                                                              ng-click="recordPendingTestResults(testBatch)"
                                                                                                              ng-disabled="!basicTTIComplete && !pendingBloodTypingTests && !pendingTTITests">Record
      Confirmatory Test Results</a></em></small> </span>
  <span has-permissions="{{permissions.ADD_TTI_OUTCOME}};{{permissions.ADD_BLOOD_TYPING_OUTCOME}}"> | </span>
  <span has-permission="{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" ng-hide="testBatch.status=='CLOSED'"> <small><em><a
          href="" ng-click="recordPendingBloodGroupMatchTests(testBatch)" ng-disabled="!pendingBloodTypingMatchTests">Record
      Confirmatory Abo/Rh Results</a></em></small> </span>
</span>

<alert type="danger" close="" ng-show="err.userMessage">
    {{err.userMessage}}
    <ul>
        <li ng-show="err['donationBatchIds']"> {{err["donationBatchIds"]}}</li>
    </ul>
</alert>
<form editable-form name="editableForm" onaftersave="updateTestBatch(testBatch)">

    <div class="h4">
        <small><em>Created On: </em></small>
        <span ng-show="!editableForm.$visible">{{ (testBatch.createdDate | bsisDate) || '' }}</span>
    <span ng-show="editableForm.$visible" style="display:inline;">
      <dateselect ng-model="testBatch.createdDate" initDate="testBatch.createdDate" format="format"
                  cal-icon="icons.CALENDAR" opened="dateToOpen"></dateselect>
    </span>
    <span ng-if="testBatch.status !== 'RELEASED' && !testBatch.permissions.canRelease">
      | <small><em>Number of Samples: </em></small>{{testBatch.numSamples}}
    </span>
    <span ng-if="testBatch.status !== 'RELEASED' && testBatch.permissions.canRelease">
      | <small><em>Number of Samples Ready for Release: </em></small>{{testBatch.readyForReleaseCount}} of {{testBatch.numSamples}}
    </span>
    <span ng-if="testBatch.status === 'RELEASED'">
      | <small><em>Number of Samples Released: </em></small>{{testBatch.numReleasedSamples}} of {{testBatch.numSamples}}
    </span>
    </div>

    <hr style="margin-bottom:5px;"/>

    <div ng-show="editableForm.$visible && testBatch.permissions.canEditDonationBatches" class="h4">
        <small><em>Donation Batches: </em></small>
    <span style="display:inline;">
      <ui-select name="donationBatches" required="true" multiple="true" ng-model="testBatch.donationBatchIds"
                 theme="bootstrap" style="width: 700px;">
          <ui-select-match placeholder="Select:">{{$item.venue.name}} ({{$item.createdDate | bsisDate}})
          </ui-select-match>
          <ui-select-choices
                  repeat="donationBatch.id as donationBatch in testBatchAvailableDonationBatches | filter:$select.search">
              <div ng-bind-html="donationBatch.venue.name"></div>
              <small>
                  {{donationBatch.createdDate | bsisDate}} |
                  {{donationBatch.numDonations}} donations
              </small>
          </ui-select-choices>
      </ui-select>
      <small class="error"
             ng-show="(editableForm.donationBatchIds.$invalid && (editableForm.donationBatchIds.donationBatches.$dirty || submitted))">
          Select one or more donation batches
      </small>
    </span>
    </div>

  <span ng-show="!editableForm.$visible || !testBatch.permissions.canEditDonationBatches">
    <span class="h4" style="font-size: 0.95em; margin-top:0px; margin-bottom:0px;"
          ng-repeat="donationBatch in testBatch.donationBatches">
      <small><em>Venue: </em></small>{{donationBatch.venue.name}} | <small><em>Date: </em></small> {{donationBatch.createdDate | bsisDate}} | <small>
        <em>Number of Donations: </em></small> {{donationBatch.numDonations}}
      <br/>
    </span>
  </span>

</form>

<hr style="margin-top:5px;"/>

<div style="padding-bottom: 5px">
    <alert type="info" ng-if="testBatch.permissions.canRelease">This test batch is ready to be released.</alert>
    <alert type="info" ng-if="testBatch.permissions.canClose">This test batch is ready to be closed.</alert>
</div>

<div class="col-sm-12">
    <div class="panel panel-default">
        <div class="panel-body">
            <p>
                <em>{{gridOptions.data.length}} sample(s) found</em> | Filter data:
                <select class="input-sm" ng-model="dataExportType"
                        ng-options="item as item.value for item in exportOptions" ng-change="filter(dataExportType)">
                </select>
                | <em> Data export: </em>

                <button class="btn btn-primary btn-ui-grid-export" ng-click="export('pdf')">PDF</button>
                <button class="btn btn-primary btn-ui-grid-export" ng-click="export('csv')">CSV</button>
            </p>
            <div class="grid" ui-grid="gridOptions" ui-grid-exporter ui-grid-pagination></div>
        </div>
    </div>
</div>

