<span class="h3 page-header">Manage Test Batch</span>

  <span class="h4" style="float: right; margin-top: 5px; padding-right: 15px; display:inline;">
    <span has-permission="{{permissions.VOID_TEST_BATCH}}" ng-hide="confirmEdit">
      <em><button class="btn btn-link" style="padding:0;" ng-click="confirmDelete = true" ng-hide="confirmDelete" ng-disabled="!testBatch.permissions.canDelete">Void</button></em>
      <span ng-show="confirmDelete">
        <em>
          <button class="btn btn-link text-danger" style="padding:0;" ng-click="deleteTestBatch(testBatch.id); confirmDelete = false">Void</button>
           <button class="btn btn-link text-muted" style="padding:0;" ng-click="confirmDelete = false">Cancel</button>
        </em>
      </span>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-hide="confirmDelete">
      <span ng-hide="confirmEdit">
      | <em><button class="btn btn-link" style="padding:0;" ng-click="editableForm.$show(); confirmEdit = true" ng-disabled="!testBatch.permissions.canEdit">Edit</button></em>
      </span>
      <span ng-show="confirmEdit">
        <em>
          <button class="btn btn-link text-muted" style="padding:0;" ng-disabled="editableForm.$waiting" ng-click="editableForm.$submit(); confirmEdit = false">Save</button>
           <button class="btn btn-link text-muted" style="padding:0;" ng-disabled="editableForm.$waiting" ng-click="editableForm.$cancel(); confirmEdit = false">Cancel</button>
        </em>
      </span>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-hide="confirmDelete || confirmEdit">
    | <em><button class="btn btn-link" style="padding:0;" ng-disabled="!testBatch.permissions.canRelease" ng-click="releaseTestBatch(testBatch)">Release</button></em>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-if="testBatch.status!='CLOSED'" ng-hide="confirmDelete || confirmEdit">
    | <em><button class="btn btn-link" style="padding:0;" ng-disabled="!testBatch.permissions.canClose" ng-click="closeTestBatch(testBatch)">Close Batch</button></em>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-if="testBatch.status=='CLOSED'" ng-hide="confirmDelete || confirmEdit">
    | <em><button class="btn btn-link" style="padding:0;" ng-disabled="!testBatch.permissions.canReopen" ng-click="reopenTestBatch(testBatch)">Reopen Batch</button></em>
    </span>
  </span>

  <span ng-if="testBatch.status!='CLOSED'" class="h4" style="float: right; margin-top: 5px; ">
    <span has-permission="{{permissions.ADD_TTI_OUTCOME}}" ng-hide="confirmDelete || confirmEdit">
      <em><button class="btn btn-link" style="padding:0;" ng-click="recordTestResults(testBatch, 'tti')">Record TTI Test Results</button></em>
    </span>
    <span has-permissions="{{permissions.ADD_TTI_OUTCOME}};{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" ng-hide="confirmDelete || confirmEdit"> | </span>
    <span has-permission="{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" ng-hide="confirmDelete || confirmEdit">
      <em><button class="btn btn-link" style="padding:0;" ng-click="recordTestResults(testBatch, 'bloodGrouping')">Record Blood Group Serology Results</button></em>
    </span>
    <span has-permissions="{{permissions.ADD_TTI_OUTCOME}};{{permissions.ADD_BLOOD_TYPING_OUTCOME}};{{permissions.VOID_TEST_BATCH}}" ng-hide="confirmDelete || confirmEdit"> | </span>
  </span>

  <hr style="clear:right;" />

<span class="h4" style="float: right; margin-top: 0px; margin-bottom: 0px; padding-right: 15px;">
  <span has-permissions="{{permissions.ADD_TTI_OUTCOME}}"  ng-hide="testBatch.status=='CLOSED'" ng-if="pendingBloodTypingTests || pendingTTITests"> <small><em><a href="" ng-click="recordPendingTestResults(testBatch)" >Record Confirmatory Test Results</a></em></small> </span>
  <span has-permissions="{{permissions.ADD_TTI_OUTCOME}};{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" 
    ng-if="(pendingBloodTypingTests || pendingTTITests) && pendingBloodTypingMatchTests"> | </span>
  <span has-permission="{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" ng-hide="testBatch.status=='CLOSED'" ng-if="pendingBloodTypingMatchTests"> <small><em><a href="" ng-click="recordPendingBloodGroupMatchTests(testBatch)" >Record Confirmatory Abo/Rh Results</a></em></small> </span>
</span>

<form editable-form name="editableForm" onaftersave="updateTestBatch(testBatch)">

  <div class="h4">
    <small><em>Created On: </em></small> 
    <span ng-show="!editableForm.$visible">{{ (testBatch.createdDate | bsisDate) || '' }}</span>
    <span ng-show="editableForm.$visible" style="display:inline;">
      <dateselect ng-model="testBatch.createdDate" initDate="testBatch.createdDate" format="format" cal-icon="icons.CALENDAR" opened="dateToOpen"></dateselect>
    </span>
    | <small><em>Number of Samples: </em></small>{{testBatch.numSamples}}
  </div>

  <hr style="margin-bottom:5px;"/>

  <div ng-show="editableForm.$visible && testBatch.permissions.canEditDonationBatches" class="h4">
    <small><em>Donation Batches: </em></small>
    <span style="display:inline;">
      <ui-select name="donationBatches" required multiple ng-model="testBatch.donationBatchIds" theme="bootstrap" ng-disabled="disabled" style="width: 700px;" >
        <ui-select-match placeholder="Select:">{{$item.venue.name}} ({{$item.createdDate | bsisDate}})</ui-select-match>
        <ui-select-choices repeat="donationBatch.id as donationBatch in testBatchAvailableDonationBatches | filter:$select.search">
          <div ng-bind-html="donationBatch.venue.name"></div>
          <small>
            {{donationBatch.createdDate | bsisDate}} |
            {{donationBatch.numDonations}} donations
          </small>
        </ui-select-choices>
      </ui-select>
      <small class="error" 
        ng-show="(editableForm.testBatch.donationBatches.$invalid && (editableForm.testBatch.donationBatches.donationBatches.$dirty || submitted))">
        Select one or more donation batches
      </small>
    </span>
  </div>

  <span ng-show="!editableForm.$visible || !testBatch.permissions.canEditDonationBatches">
    <span class="h4" style="font-size: 0.95em; margin-top:0px; margin-bottom:0px;" ng-repeat="donationBatch in testBatch.donationBatches"> 
      <small><em>Center: </em></small>{{donationBatch.venue.name}} | <small><em>Date: </em></small> {{donationBatch.createdDate | bsisDate}} | <small><em>Number of Donations: </em></small> {{donationBatch.numDonations}}
      <br/>
    </span>
  </span>

</form>

<hr style="margin-top:5px;"/>

<div style="padding-bottom: 5px"></div>

<div class="col-sm-12">
  <div class="panel panel-default">
    <div class="panel-body">
      <table ng-table="testSamplesTableParams" show-filter="false" class="table">
        <tr ng-repeat="sample in $data"
            ng-click=""
            ng-mouseenter="this.$selected = true"
            ng-mouseleave="this.$selected = false"
            ng-class="{'active': sample.$selected}">
            <td data-title="'DIN'" header-class="text-left" class="text-center" sortable="'donationIdentificationNumber'">
                {{sample.donationIdentificationNumber}}
            </td>
            <td data-title="'Date Bled'" header-class="text-left" class="text-center" sortable="'donationDate'">
                {{sample.donationDate | bsisDate}}
            </td>
            <td data-title="'Pack'" header-class="text-left" sortable="'packType'">
                {{sample.packType.packType}}
            </td>
            <td data-title="'Clinic'" header-class="text-left" sortable="'center'">
                {{sample.venue.name}}
            </td>
            <td data-title="'TTI Testing'" header-class="text-left" sortable="'ttiStatus'">
                {{sample.ttistatus}}
            </td>
            <td data-title="'Blood Group Serology'" header-class="text-left" sortable="'bloodTypingStatus'">
                <span ng-if="sample.bloodTypingStatus!= 'NOT_DONE'">{{sample.bloodTypingStatus}} - </span>{{sample.bloodTypingMatchStatus}} <em><span ng-if="sample.bloodAbo || sample.bloodRh"> ({{sample.bloodAbo}}{{sample.bloodRh}}) </span></em>
            </td>
        </tr>
      </table>
    </div>
  </div>
</div>

