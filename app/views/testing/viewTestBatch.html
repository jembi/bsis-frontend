<div class="col-sm-3 col-md-2" ng-include="'views/testing/sidebar.html'"></div>
<div class="col-sm-9 col-md-10 main">
  <span class="h3 page-header">Manage Test Batch</span>

  <span class="h4" style="float:right; margin-top: 5px; padding-right: 15px; display:inline;">
    <span has-permission="{{permissions.VOID_TEST_BATCH}}" ng-hide="confirmEdit">
      <em>
          <button class="btn btn-link" style="padding:0;" ng-click="confirmDelete = true" ng-hide="confirmDelete"
                  ng-disabled="!testBatch.permissions.canDelete">Void
          </button>
      </em>
      <span ng-show="confirmDelete">
        <em>
            <button class="btn btn-link text-danger" style="padding:0;"
                    ng-click="deleteTestBatch(testBatch.id); confirmDelete = false">Void
            </button>
            <button class="btn btn-link text-muted" style="padding:0;" ng-click="confirmDelete = false">Cancel</button>
        </em>
      </span>
    </span>
    <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-hide="confirmDelete">
      <span ng-hide="confirmEdit">
      | <em>
          <button class="btn btn-link" style="padding:0;" ng-click="editableForm.$show(); confirmEdit = true"
                  ng-disabled="!testBatch.permissions.canEdit">Edit
          </button>
      </em>
      </span>
      <span ng-show="confirmEdit">
        <em>
            <button class="btn btn-link text-muted" style="padding:0;" ng-disabled="editableForm.$waiting"
                    ng-click="editableForm.$submit();">Save
            </button>
            <button class="btn btn-link text-muted" style="padding:0;" ng-disabled="editableForm.$waiting"
                    ng-click="editableForm.$cancel(); confirmEdit = false">Cancel
            </button>
        </em>
      </span>
    </span>
    <span style="margin-left: 20px; margin-top: -15px; float:right">
      <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-if="testBatch.status === 'OPEN'" ng-hide="confirmDelete || confirmEdit">
        <button class="btn btn-primary" ng-disabled="!testBatch.permissions.canRelease" ng-click="releaseTestBatch(testBatch)">Release</button>
      </span>
      <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-if="testBatch.status === 'RELEASED'" ng-hide="confirmDelete || confirmEdit">
        <button class="btn btn-primary" ng-disabled="!testBatch.permissions.canClose" ng-click="closeTestBatch(testBatch)">Close Batch</button>
      </span>
      <span has-permission="{{permissions.EDIT_TEST_BATCH}}" ng-if="testBatch.status === 'CLOSED'"  ng-hide="confirmDelete || confirmEdit">
        <button class="btn btn-primary" ng-click="reopenTestBatch(testBatch)">Reopen Batch</button>
      </span>
    </span>
  </span>

  <hr style="clear:right;"/>

  <span ng-if="testBatch.status!='CLOSED'" ng-hide="confirmDelete || confirmEdit" class="h4" style="float: right; margin-top: -10px; margin-bottom: 0px; padding-right: 15px; text-align: right;">
    <span has-permission="{{permissions.ADD_TTI_OUTCOME}}" ng-hide="confirmDelete || confirmEdit">
      <small>
        <em>TTI Test Outcomes:
          <a ng-href="#/manageTTITesting/{{testBatch.id}}/BASIC_TTI">Enter </a>|
        </em>
        <em>
          <a ng-href="#/reEnterTTI/{{testBatch.id}}/BASIC_TTI" ng-disabled="!reEntryRequiredTTITests">Re-Enter</a>
        </em>
      </small>
    </span>
    <span has-permissions="{{permissions.ADD_TTI_OUTCOME}};{{permissions.ADD_BLOOD_TYPING_OUTCOME}}"
          ng-hide="confirmDelete || confirmEdit"> | </span>
    <span has-permission="{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" ng-hide="confirmDelete || confirmEdit">
      <small>
        <em>ABO/Rh Outcomes:
          <a ng-href="#/manageBloodGroupTesting/{{testBatch.id}}/BASIC_BLOODTYPING">Enter </a>|
        </em>
        <em>
          <a ng-href="#/reEnterBloodTyping/{{testBatch.id}}/BASIC_BLOODTYPING" ng-disabled="!reEntryRequiredBloodTypingTests">Re-Enter</a>
        </em>
      </small>
    </span>
    <br/>
    <span has-permissions="{{permissions.ADD_TTI_OUTCOME}}" ng-hide="testBatch.status=='CLOSED'"> 
      <small>
        <em>Pending TTI Test Outcomes:      
          <a ng-href="#/managePendingTests/{{testBatch.id}}/CONFIRMATORY_TTI" ng-disabled="!basicTTIComplete && !pendingTTITests">Enter </a>|
        </em> 
        <em>  
          <a ng-href="#/reEnterTTI/{{testBatch.id}}/CONFIRMATORY_TTI" ng-disabled="!reEntryRequiredPendingTTITests">Re-Enter</a>
        </em> 
      </small>
    </span>

    <span has-permissions="{{permissions.ADD_TTI_OUTCOME}};{{permissions.ADD_BLOOD_TYPING_OUTCOME}}"> | </span>
    <span has-permission="{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" ng-hide="testBatch.status=='CLOSED'">
      <small>
        <em>Pending ABO/Rh Outcomes:
          <a ng-href="#/managePendingBloodTypingTests/{{testBatch.id}}/REPEAT_BLOODTYPING" ng-disabled="!basicBloodTypingComplete && !pendingBloodTypingTests">Enter </a>|
        </em>
        <em>
          <a ng-href="#/reEnterBloodTyping/{{testBatch.id}}/REPEAT_BLOODTYPING" ng-disabled="!reEntryRequiredPendingBloodTypingTests">Re-Enter</a>
        </em>
      </small>
    </span>

  </span>

  <uib-alert type="danger" close="" ng-show="err.userMessage">
      {{err.userMessage}}
      <ul>
          <li ng-show="err['donationBatchIds']"> {{err["donationBatchIds"]}}</li>
      </ul>
  </uib-alert>
  <form editable-form name="editableForm" onbeforesave="validateForm(editableForm)" onaftersave="updateTestBatch(testBatch)">

      <div class="h4">
        <small><em>Created On: </em></small>
        <span ng-show="!editableForm.$visible">{{ (testBatch.createdDate | bsisDate) || '' }}</span>
        <span ng-show="editableForm.$visible" style="display:inline;">
          <dateselect ng-model="testBatch.createdDate" initDate="testBatch.createdDate" format="format" opened="dateToOpen"></dateselect>
        </span> 
        | <small><em>Location: </em></small><span style="display:inline;">{{testBatch.location.name}}</span>
      </div>

      <div class="h4">
        <span ng-if="testBatch.status !== 'RELEASED' && !testBatch.permissions.canRelease">
          <small><em>Number of Samples: </em></small>{{testBatch.numSamples}}
        </span>
        <span ng-if="testBatch.status !== 'RELEASED' && testBatch.permissions.canRelease">
          <small><em>Number of Samples Ready for Release: </em></small>{{testBatch.readyForReleaseCount}} of {{testBatch.numSamples}}
        </span>
        <span ng-if="testBatch.status === 'RELEASED'">
          <small><em>Number of Samples Released: </em></small>{{testBatch.numReleasedSamples}} of {{testBatch.numSamples}}
        </span>
      </div>

      <hr style="margin-bottom:5px;"/>

  <span ng-hide="confirmDelete || confirmEdit" class="h4" style="float: right; margin-top: 0px; margin-bottom: 0px; padding-right: 15px;">
    <span has-permission="{{permissions.ADD_BLOOD_TYPING_OUTCOME}}" ng-hide="testBatch.status=='CLOSED'"> <small><em><a
            ng-href="#/manageBloodGroupMatchTesting/{{testBatch.id}}" ng-disabled="!pendingBloodTypingConfirmations">Resolve Ambiguous ABO/Rh Outcomes</a></em></small> </span>
  </span>

      <div ng-show="editableForm.$visible && testBatch.permissions.canEditDonationBatches">
          <small><em>Donation Batches: </em></small>
        <div class="form-group" >
            <ui-select name="donationBatches" multiple ng-model="testBatch.donationBatchIds" ui-select-required
                       style="width: 700px;">
                <ui-select-match placeholder="Select:">{{$item.venue.name}} ({{$item.createdDate | bsisDate}})
                </ui-select-match>
                <ui-select-choices
                        repeat="donationBatch.id as donationBatch in testBatchAvailableDonationBatches | filter:$select.search">
                    <div ng-bind-html="donationBatch.venue.name"></div>
                    <small>
                        {{donationBatch.createdDate | bsisDate}} |
                        {{donationBatch.numDonations}} donations
                    </small>
                </ui-select-choices>
            </ui-select>
            <small class="error" ng-show="editableForm.$error.uiSelectRequired">
                Select one or more donation batches
            </small>
        </div>
      </div>

    <span ng-show="!editableForm.$visible || !testBatch.permissions.canEditDonationBatches">
      <span class="h4" style="font-size: 0.95em; margin-top:0px; margin-bottom:0px;"
            ng-repeat="donationBatch in testBatch.donationBatches">
        <small><em>Venue: </em></small>{{donationBatch.venue.name}} | <small><em>Date: </em></small> {{donationBatch.createdDate | bsisDate}} | <small>
          <em>Number of Donations: </em></small> {{donationBatch.numDonations}}
        <br/>
      </span>
    </span>

  </form>

  <hr style="margin-top:5px;"/>

  <div style="padding-bottom: 5px">
      <uib-alert type="info" ng-if="testBatch.permissions.canRelease">This test batch is ready to be released.</uib-alert>
      <uib-alert type="info" ng-if="testBatch.permissions.canClose">This test batch is ready to be closed.</uib-alert>
  </div>

  <div class="col-sm-12">
      <div class="panel panel-default">
          <div class="panel-body">
              <p>
                  <em>{{gridOptions.data.length}} sample(s) found</em> | Filter data:
                  <select class="input-sm" ng-model="dataExportType"
                          ng-options="item as item.value for item in exportOptions" ng-change="filter(dataExportType)">
                  </select>
                  | <em> Data export: </em>

                  <button class="btn btn-primary btn-ui-grid-export" ng-click="export('pdf')">PDF</button>
                  <button class="btn btn-primary btn-ui-grid-export" ng-click="export('csv')">CSV</button>
              </p>
              <div class="grid" ui-grid="gridOptions" ui-grid-exporter ui-grid-pagination></div>
          </div>
      </div>
  </div>
</div>
